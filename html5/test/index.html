<html>
<head>
<title>JW Player Testing Tool</title>
<link rel="stylesheet" href="files/style.css" type="text/css">
<script type="text/javascript" src="../lib/jquery.js"></script>
<script type="text/javascript" src="../jquery.jwplayer.js"></script>
<script type="text/javascript">

	/** List with settings for this testing tool (skins / examples). **/
	var settings = {
		players: { 
			html5:'../jquery.jwplayer.js'
		},
		skins: {
			none:'',
			beelden:'../../../skins/beelden/beelden.xml',
			bekle:'../../../skins/bekle/bekle.xml',
			bluemetal:'../../../skins/bluemetal/bluemetal.xml',
			classic:'../../../skins/classic/classic.xml',
			five:'../../../skins/five/five.xml',
			grungetape:'../../../skins/grungetape/grungetape.xml',
			icecreamsneaka:'../../../skins/icecreamsneaka/icecreamsneaka.xml',
			kleur:'../../../skins/kleur/kleur.xml',
	        lulu:'../../../skins/lulu/lulu.xml',
			modieus:'../../../skins/modieus/modieus.xml',
			nacht:'../../../skins/nacht/nacht.xml',
			playcasso:'../../../skins/playcasso/playcasso.xml',
			schoon:'../../../skins/schoon/schoon.xml',
			snel:'../../../skins/snel/snel.xml',
	        stormtrooper:'../../../skins/stormtrooper/stormtrooper.xml'
		},
		plugins: {},
		examples: {
			'': {},
			'MP4 video': {
				file:'files/bunny.mp4',
				flashplayer:'../../fl5/player.swf',
				skin:'five',
				height:240,
				width:500
			},
			'OGG video': {
				file:'files/bunny.ogv',
				flashplayer:'../../fl5/player.swf',
				skin:'five',
				height:240,
				width:500
			},
			'FLV video': {
				file:'files/bunny.flv',
				flashplayer:'../../fl5/player.swf',
				skin:'five',
				height:240,
				width:500
			},
			' ': {},
			'MP4 video with image': {
				file:'files/bunny.mp4',
				image:'files/bunny.jpg',
				skin:'five',
				height:240,
				width:500
			},
			'OGG without flashplayer': {
				file:'files/bunny.ogv',
				skin:'five',
				height:240,
				width:500
			},
			'Long MP4 video with autostart': {
				autostart: true,
				file:'http://content.bitsontherun.com/videos/LJSVMnCF-327.mp4',
				image:'http://content.bitsontherun.com/thumbs/LJSVMnCF-320.jpg',
				skin:'five',
				height:240,
				width:500
			}
		}
	};



	/**
	* Initialization section. Parses settings and the browser querystring.
	* This section is only executed on page (re)load.
	**/

	/** The complete list with all current flashvars. **/
	var variables = {};
	/** When jQuery is loaded, we initialize everything. **/
	$().ready(function() { loadSettings(); });
	/** Load the settings and querystring. **/
	function loadSettings() {
		// load the settings.
		for (itm in settings['examples']) { $("#examples").append("<option>"+itm+"</option>"); }
		for (itm in settings['players']) { $("#players").append("<option>"+itm+"</option>"); }
		for (itm in settings['skins']) { $("#skins").append("<option>"+itm+"</option>"); }
		for (itm in settings['plugins']) { $("#plugins").append("<option>"+itm+"</option>"); }
		// When an example is selected, we reload the entire page.
		$("#examples").change(function(evt) {
			evt.preventDefault();
			var obj = settings.examples[$('#examples').val()];
			window.top.location.href = window.top.location.pathname+'?'+$.param(obj);
		 });
		// get the options from the querystring.
		window.top.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g,function () {
			variables[decodeURIComponent(arguments[1])] = decodeURIComponent(arguments[2]);
		});
		// Set the handlers on the API calls
		$("#variablesform").submit(function(evt) { getVariable(evt); });
		$("#sendeventform").submit(function(evt) { sendEvent(evt); });
		$("#listenersform").submit(function(evt) { setListener(evt); });
		// set the value and handler on player, skin and plugins.
		if(variables['player']) { $('#players').val(variables['player']); }
		$("#players").change(function(evt) { reloadFieldsets(evt); });
		if(variables['skin']) { $('#skins').val(variables['skin']); }
		$("#skins").change(function(evt) { reloadPage(evt); });
		//if(variables['plugins']) { $('#plugins').val(variables['plugins'].split(',')); }
		$("#plugins").change(function(evt) { reloadFieldsets(evt); });
		// set the handler on the flashvars and load the whole bunch.
		$("#flashvarsform").submit(function(evt) { reloadPage(evt); });
		reloadFieldsets();
	};



	/**
	* Fieldset insertion section. Loads the player/plugins XML files to print the appropriate fieldsets.
	* This section is executed every time the player/plugins selection changes.
	**/

	/** The number of XML files that still need to be parsed. **/
	var parsing;
	/** All variables that are inserted in an XML-defined field. **/
	var prefilled;
	/** Check for inserting of fieldsets. **/
	function reloadFieldsets(evt) {
		if(evt) { evt.preventDefault(); }
		$("#flashvarsform > .removable").remove();
		$("#fieldsettabs > .removable").remove();
		$("#custom > .removable").remove();
		parsing = 1;
		prefilled = {plugins:'',player:'',skin:''};
		var swf = settings.players[$("#players").val()];
		var xml = swf.substr(0,swf.lastIndexOf('.')) + '.xml';
		parsePlayerXML(xml);
		var str = $("#plugins").val();
		if(str != null) {
			arr = str.toString().split(',');
			for (var i=0; i<arr.length; i++) {
				parsing++;
				swf = settings[settings.plugin_api+'_plugins'][arr[i]];
				xml = swf.substr(0,swf.length-4) + '.xml';
				parsePluginXML(xml,arr[i]);
			}
		}
	};
	/** Insert a specific plugin fieldset. **/
	function parsePlayerXML(url) {
		$.get(url,{},function(xml) {
			var arr = $('player',xml).find('flashvars');
			for (var i=0; i<arr.length; i++) {
				var nam = $(arr[i]).attr('section').toLowerCase();
				insertFieldset(arr[i],nam);
			}
			parsing--;
			if(parsing == 0) { setCustomTabbing(); }
		});
	};
	/** Insert a specific plugin fieldset. **/
	function parsePluginXML(url,nam) {
		$.get(url,{},function(xml) {
			var arr = $('flashvars',xml).find('flashvar');
			if(arr.length > 0) {
				insertFieldset(xml,nam,true);
			}
			parsing--;
			if(parsing == 0) { setCustomTabbing(); }
		});
	};
	/** Insert a specific plugin fieldset. **/
	function insertFieldset(xml,nam,plg) {
		var tit = nam.substr(0,1).toUpperCase()+nam.substr(1);
		var set = '<fieldset id="'+nam+'" class="removable">';
		var arr = $(xml).find('flashvar');
		$("#customli").before('<li class="removable">'+tit+'</li>');
		for (var i=0; i<arr.length; i++) {
			var val = $('name',arr[i]).text();
			if(plg) { val = nam+'.'+val; }
			set +='<label>'+val+'</label><input type="text" name="'+val+'" ';
			if(variables[val]) {
				set += 'value="'+variables[val]+'" ';
				prefilled[val] = variables[val];
			}
			set += "/>";
		}
		set += '</fieldset>';
		$('#custom').before(set);
	};
	/** Set the custom fields and the tabbing functionality. **/
	function setCustomTabbing() {
		for(var itm in variables) { 
			if(prefilled[itm] == undefined) {
				var elm = '<label class="removable">'+itm+'</label>'
				elm += '<input type="text" name="'+itm+'" value="'+variables[itm]+'" class="removable"/>';
				$("#custom").append(elm);
			}
		}
		$('li').click(function() {
			$('li').removeClass('active');
			$(this).addClass('active');
			var itm = $(this).text().toLowerCase();
			doTab($.trim(itm));
		});
		doTab('sources');
		insertPlayer();
	};
	/** Flip to a tab. **/
	function doTab(itm) {
		var arr = $("#flashvarsform").find('fieldset');
		for(var i=0; i<arr.length; i++) {
			if($(arr[i]).attr('id') == itm) {
				$(arr[i]).css('display','block');
			} else {
				$(arr[i]).css('display','none');
			}
		}
	};



	/**
	* Player insertion section. Gathers variables from all fields and prints the player on the page.
	* This section is executed every time the flashvars form is submitted.
	**/

	/** Print the player on the page. **/
	function insertPlayer() {
		variables['skin'] = settings.skins[variables['skin']];
		var lnk = 'http://developer.longtailvideo.com/player/trunk/html5/test/';
		$("#permalink").val(lnk+'?'+$.param(variables));
		if(variables['file']) {
			$('#container').attr('src',variables['file']);
		}
		if(variables['image']) { 
			$('#container').attr('poster',variables['image']);
		}
		for (itm in variables) {
			variables[itm] = serialize(variables[itm]);
		}
		$('#container').jwplayer(variables);
	};
	/** Change the page URL. **/
	function reloadPage(evt) {
		if(evt) { evt.preventDefault(); }
		variables = {}
		if($("#skins").val() != 'none') {
			variables['skin'] = $("#skins").val();
		}
		var arr = $("#flashvarsform").find('input');
		for(var i=0; i<arr.length; i++) {
			if($(arr[i]).val()) {
				variables[$(arr[i]).attr('name')] = $(arr[i]).val();
			}
		}
		window.top.location.href = window.top.location.pathname+'?'+$.param(variables);
	};
	/** Convert strings to booleans. **/
	function serialize(str) {
		if(str == 'true') {
			return true;
		} else if (str == 'false') {
			return false;
		} else if(isNaN(str/1) || str.length == 6) {
			return str;
		} else {
			return Number(str);
		}
	}



	/**
	* Player API section. Contains functions for getting a player reference and executing API calls.
	* This section is executed when a user starts interacting with the player API.
	**/

	/** Get a variable from the player. **/
	function getVariable(evt) {
		evt.preventDefault();
		var typ = $('#vartype').val().toString();
		var prp = $.jwplayer()[typ]();
		alert(prp);
	};
	/** Send an event to the player. **/
	function sendEvent(evt) {
		evt.preventDefault();
		var typ = $('#sendevent').val();
		var pr1 = serialize($('#sendeventdata1').val());
		var pr2 = serialize($('#sendeventdata2').val());
		if((pr2 !== undefined) && (pr2 !== null)) {
			$.jwplayer()[typ](pr1,pr2);
		} else if ((pr1 !== undefined) && (pr1 !== null)) { 
			$.jwplayer()[typ](pr1);
		} else { 
			$.jwplayer()[typ]();
		}
	};
	/** Set a listener to the player. **/
	function setListener(evt) {
		evt.preventDefault();
		var typ = $('#eventtype').val();
		$.jwplayer()[typ](alertValue);
	};
	/** Alert responses from the player. **/
	function alertValue(obj) {
		var txt = '';
		for (itm in obj) {
			if(typeof(obj[itm]) == 'object') {
				txt += itm+':\n';
				for (ent in obj[itm]) {
					txt += '  '+ent+': '+obj[itm][ent]+'\n';
				}
			} else {
				txt += itm+': '+obj[itm]+'\n';
			}
		}
		try {
			console.log(txt);			
		} catch(err) {
			alert(txt);
		}
	};



</script>
</head>
<body>



<form id="examplesform">
	<fieldset>
		<label>Load an example setup</label>
		<select name="examples" id="examples"></select>
		<label>Permalink of this setup</label>
		<input name="permalink" id="permalink"/>
	</fieldset>
</form>



<div id="javascript">
	<form id="variablesform">
		<fieldset>
			<label>Property</label>
			<select type="text" id="vartype">
				<option>buffer</option>
				<option>duration</option>
				<!-- <option>fullscreen</option> -->
				<!-- <option>height</option> -->
				<option>mute</option>
				<option>position</option>
				<option>state</option>
				<option>volume</option>
				<!-- <option>width</option> -->
			</select>
		</fieldset>
		<button type="submit" id="variablesbutton">Get property</button>
	</form>
	<form id="sendeventform">
		<fieldset>
			<label>Method</label>
			<select type="text" id="sendevent">
				<!-- <option>fullscreen</option> -->
				<!-- <option>load</option> -->
				<option>mute</option>
				<option>pause</option>
				<option>play</option>
				<!-- <option>resize</option> -->
				<option>seek</option>
				<option>stop</option>
				<option>volume</option>
			</select>
			<label>Parameter</label>
			<input type="text" id="sendeventdata1" />
			<!-- <label>Parameter 2</label>
			<input type="text" id="sendeventdata2" /> -->
		</fieldset>
		<button type="submit" id="sendeventbutton">Call method</button>
	</form>
	<form id="listenersform">
		<fieldset>
			<label>Event</label>
			<select type="text" id="eventtype">
				<option>buffer</option>
				<option>complete</option>
				<option>error</option>
				<!-- <option>fullscreen</option> -->
				<!-- <option>loaded</option> -->
				<option>meta</option>
				<option>mute</option>
				<!-- <option>resize</option> -->
				<option>state</option>
				<option>time</option>
				<option>volume</option>
			</select>
		</fieldset>
		<button type="submit" id="listenersbutton">Listen to event</button>
	</form>
</div>



<div id="preview">
	<video id="container" width="400" height="200">
		Your browser supports neither video nor flash.
	</video>
</div>



<form id="flashvarsform">
	<ul id="fieldsettabs">
		<li class="active">Sources</li>
		<li id="customli">Custom</li>
	</ul>
	<fieldset></fieldset>
	<fieldset id="sources">
		<label>player</label>
		<select id="players"></select>
		<label>skin</label>
		<select id="skins"></select>
		<!-- <label>plugins</label>
		<select multiple="multiple" id="plugins"></select> -->
	</fieldset>
	<fieldset id="custom">
		<p>
			This fieldset contains variables not claimed by the player or plugin.
			They can be entered in the browser querystring to show up here.
		</p>
	</fieldset>
	<button type="submit">Reload player</button>
</form>



</body>
</html>
